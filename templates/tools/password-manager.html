{% extends "base.html" %}

{% block title %}Password Manager - DiskTools{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <!-- Header -->
    <div class="text-center mb-12">
        <div class="inline-block p-4 bg-gradient-to-r from-primary to-secondary rounded-full mb-6">
            <i class="fas fa-shield-alt text-4xl text-white"></i>
        </div>
        <h1 class="text-4xl font-bold mb-4 text-gradient">Password Manager</h1>
        <p class="text-xl text-gray-300">Generate secure passwords and analyze password strength</p>
    </div>

    <!-- Password Manager Interface -->
    <div class="max-w-6xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Password Generator -->
            <div class="lg:col-span-2">
                <div class="glass rounded-2xl p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-key text-primary mr-3"></i>
                        Password Generator
                    </h2>
                    
                    <!-- Generated Password Display -->
                    <div class="mb-6">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="generatedPassword" 
                                readonly 
                                class="w-full p-4 bg-dark/50 border border-white/20 rounded-xl text-white font-mono text-lg pr-24"
                                placeholder="Click generate to create a password"
                            >
                            <div class="absolute right-2 top-2 flex space-x-2">
                                <button id="copyPassword" class="p-2 bg-primary/20 hover:bg-primary/30 rounded-lg transition-colors">
                                    <i class="fas fa-copy text-primary"></i>
                                </button>
                                <button id="refreshPassword" class="p-2 bg-secondary/20 hover:bg-secondary/30 rounded-lg transition-colors">
                                    <i class="fas fa-sync text-secondary"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Strength Indicator -->
                        <div class="mt-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-300">Password Strength</span>
                                <span id="strengthText" class="font-bold">-</span>
                            </div>
                            <div class="w-full bg-dark/50 rounded-full h-2">
                                <div id="strengthBar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generator Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Password Length</label>
                            <input id="passwordLength" type="range" min="4" max="128" value="16" class="w-full mb-2">
                            <div class="text-center text-sm text-gray-400">
                                <span id="lengthValue">16</span> characters
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input id="includeUppercase" type="checkbox" checked class="toggle-switch">
                                <span class="text-gray-300">Uppercase (A-Z)</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input id="includeLowercase" type="checkbox" checked class="toggle-switch">
                                <span class="text-gray-300">Lowercase (a-z)</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input id="includeNumbers" type="checkbox" checked class="toggle-switch">
                                <span class="text-gray-300">Numbers (0-9)</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input id="includeSymbols" type="checkbox" checked class="toggle-switch">
                                <span class="text-gray-300">Symbols (!@#$%)</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input id="excludeSimilar" type="checkbox" class="toggle-switch">
                                <span class="text-gray-300">Exclude Similar (0,O,l,1)</span>
                            </label>
                        </div>
                    </div>
                    
                    <button id="generatePassword" class="btn-primary w-full mt-6">
                        <i class="fas fa-magic mr-2"></i>
                        Generate Password
                    </button>
                </div>
                
                <!-- Password Analyzer -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-search text-primary mr-3"></i>
                        Password Analyzer
                    </h2>
                    
                    <div class="mb-4">
                        <input 
                            type="password" 
                            id="passwordToAnalyze" 
                            placeholder="Enter a password to analyze its strength..."
                            class="w-full p-4 bg-dark/50 border border-white/20 rounded-xl text-white"
                        >
                        <button id="togglePasswordVisibility" class="absolute right-4 top-4 text-gray-400 hover:text-white">
                            <i class="fas fa-eye" id="eyeIcon"></i>
                        </button>
                    </div>
                    
                    <!-- Analysis Results -->
                    <div id="analysisResults" class="space-y-4 hidden">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-dark/30 rounded-lg p-3">
                                <div class="text-lg font-bold text-blue-400" id="analyzedLength">0</div>
                                <div class="text-xs text-gray-400">Length</div>
                            </div>
                            <div class="bg-dark/30 rounded-lg p-3">
                                <div class="text-lg font-bold text-green-400" id="analyzedEntropy">0</div>
                                <div class="text-xs text-gray-400">Entropy</div>
                            </div>
                            <div class="bg-dark/30 rounded-lg p-3">
                                <div class="text-lg font-bold text-yellow-400" id="crackTime">0s</div>
                                <div class="text-xs text-gray-400">Crack Time</div>
                            </div>
                            <div class="bg-dark/30 rounded-lg p-3">
                                <div class="text-lg font-bold text-purple-400" id="uniqueChars">0</div>
                                <div class="text-xs text-gray-400">Unique Chars</div>
                            </div>
                        </div>
                        
                        <!-- Security Checklist -->
                        <div class="bg-dark/30 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">Security Checklist</h4>
                            <div id="securityChecklist" class="space-y-2">
                                <!-- Checklist items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Recommendations -->
                        <div id="recommendations" class="bg-dark/30 rounded-lg p-4">
                            <h4 class="font-semibold mb-3">Recommendations</h4>
                            <div id="recommendationsList" class="space-y-1 text-sm">
                                <!-- Recommendations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Quick Presets -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt text-primary mr-3"></i>
                        Quick Presets
                    </h3>
                    
                    <div class="space-y-3">
                        <button class="preset-btn w-full text-left p-3 bg-dark/30 rounded-lg hover:bg-primary/20 transition-colors" data-preset="simple">
                            <div class="font-semibold">Simple</div>
                            <div class="text-sm text-gray-400">8 chars, letters + numbers</div>
                        </button>
                        <button class="preset-btn w-full text-left p-3 bg-dark/30 rounded-lg hover:bg-primary/20 transition-colors" data-preset="strong">
                            <div class="font-semibold">Strong</div>
                            <div class="text-sm text-gray-400">16 chars, all characters</div>
                        </button>
                        <button class="preset-btn w-full text-left p-3 bg-dark/30 rounded-lg hover:bg-primary/20 transition-colors" data-preset="ultra">
                            <div class="font-semibold">Ultra Secure</div>
                            <div class="text-sm text-gray-400">32 chars, maximum security</div>
                        </button>
                        <button class="preset-btn w-full text-left p-3 bg-dark/30 rounded-lg hover:bg-primary/20 transition-colors" data-preset="pin">
                            <div class="font-semibold">PIN Code</div>
                            <div class="text-sm text-gray-400">6 digits only</div>
                        </button>
                    </div>
                </div>
                
                <!-- Password History -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-history text-primary mr-3"></i>
                        Recent Passwords
                    </h3>
                    
                    <div id="passwordHistory" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-gray-400 text-sm text-center py-4">No passwords generated yet</p>
                    </div>
                    
                    <button id="clearHistory" class="btn-secondary w-full mt-4">
                        <i class="fas fa-trash mr-2"></i>
                        Clear History
                    </button>
                </div>
                
                <!-- Security Tips -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-primary mr-3"></i>
                        Security Tips
                    </h3>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check text-green-400 mt-1"></i>
                            <span class="text-gray-300">Use unique passwords for each account</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check text-green-400 mt-1"></i>
                            <span class="text-gray-300">Enable two-factor authentication</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check text-green-400 mt-1"></i>
                            <span class="text-gray-300">Use a password manager</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check text-green-400 mt-1"></i>
                            <span class="text-gray-300">Avoid personal information</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check text-green-400 mt-1"></i>
                            <span class="text-gray-300">Update passwords regularly</span>
                        </div>
                    </div>
                </div>
                
                <!-- Export Options -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-download text-primary mr-3"></i>
                        Export
                    </h3>
                    
                    <div class="space-y-3">
                        <button id="exportPasswords" class="w-full btn-secondary">
                            <i class="fas fa-file-export mr-2"></i>
                            Export Passwords
                        </button>
                        <button id="printPasswords" class="w-full btn-secondary">
                            <i class="fas fa-print mr-2"></i>
                            Print List
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
class PasswordManager {
    constructor() {
        this.history = JSON.parse(localStorage.getItem('disktools-password-history') || '[]');
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.generatePassword();
        this.updateHistory();
    }

    setupEventListeners() {
        // Generator controls
        document.getElementById('generatePassword').addEventListener('click', () => this.generatePassword());
        document.getElementById('refreshPassword').addEventListener('click', () => this.generatePassword());
        document.getElementById('copyPassword').addEventListener('click', () => this.copyPassword());
        
        // Length slider
        document.getElementById('passwordLength').addEventListener('input', (e) => {
            document.getElementById('lengthValue').textContent = e.target.value;
            this.generatePassword();
        });
        
        // Checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => this.generatePassword());
        });
        
        // Presets
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const preset = e.currentTarget.dataset.preset;
                this.applyPreset(preset);
            });
        });
        
        // Password analyzer
        document.getElementById('passwordToAnalyze').addEventListener('input', (e) => {
            this.analyzePassword(e.target.value);
        });
        
        // Toggle password visibility
        document.getElementById('togglePasswordVisibility').addEventListener('click', () => {
            this.togglePasswordVisibility();
        });
        
        // History management
        document.getElementById('clearHistory').addEventListener('click', () => this.clearHistory());
        
        // Export functions
        document.getElementById('exportPasswords').addEventListener('click', () => this.exportPasswords());
        document.getElementById('printPasswords').addEventListener('click', () => this.printPasswords());
    }

    generatePassword() {
        const length = parseInt(document.getElementById('passwordLength').value);
        const includeUppercase = document.getElementById('includeUppercase').checked;
        const includeLowercase = document.getElementById('includeLowercase').checked;
        const includeNumbers = document.getElementById('includeNumbers').checked;
        const includeSymbols = document.getElementById('includeSymbols').checked;
        const excludeSimilar = document.getElementById('excludeSimilar').checked;
        
        let charset = '';
        if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
        if (includeNumbers) charset += '0123456789';
        if (includeSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';
        
        if (excludeSimilar) {
            charset = charset.replace(/[0O1lI]/g, '');
        }
        
        if (!charset) {
            ToolAPI.showError('Please select at least one character type');
            return;
        }
        
        let password = '';
        for (let i = 0; i < length; i++) {
            password += charset.charAt(Math.floor(Math.random() * charset.length));
        }
        
        document.getElementById('generatedPassword').value = password;
        this.analyzeGeneratedPassword(password);
        this.addToHistory(password);
    }

    analyzeGeneratedPassword(password) {
        const strength = this.calculatePasswordStrength(password);
        this.updateStrengthIndicator(strength);
    }

    analyzePassword(password) {
        const resultsDiv = document.getElementById('analysisResults');
        
        if (!password) {
            resultsDiv.classList.add('hidden');
            return;
        }
        
        resultsDiv.classList.remove('hidden');
        
        // Basic metrics
        document.getElementById('analyzedLength').textContent = password.length;
        document.getElementById('analyzedEntropy').textContent = this.calculateEntropy(password).toFixed(1);
        document.getElementById('crackTime').textContent = this.estimateCrackTime(password);
        document.getElementById('uniqueChars').textContent = new Set(password).size;
        
        // Security checklist
        this.updateSecurityChecklist(password);
        
        // Recommendations
        this.updateRecommendations(password);
    }

    calculatePasswordStrength(password) {
        let score = 0;
        
        // Length bonus
        score += Math.min(password.length * 4, 50);
        
        // Character variety bonus
        if (/[a-z]/.test(password)) score += 5;
        if (/[A-Z]/.test(password)) score += 5;
        if (/[0-9]/.test(password)) score += 5;
        if (/[^A-Za-z0-9]/.test(password)) score += 10;
        
        // Pattern penalties
        if (/(.)\1{2,}/.test(password)) score -= 10; // Repeated characters
        if (/123|abc|qwe/i.test(password)) score -= 10; // Common sequences
        
        return Math.min(Math.max(score, 0), 100);
    }

    calculateEntropy(password) {
        const charsets = [
            { regex: /[a-z]/, size: 26 },
            { regex: /[A-Z]/, size: 26 },
            { regex: /[0-9]/, size: 10 },
            { regex: /[^A-Za-z0-9]/, size: 32 }
        ];
        
        let charsetSize = 0;
        charsets.forEach(charset => {
            if (charset.regex.test(password)) {
                charsetSize += charset.size;
            }
        });
        
        return password.length * Math.log2(charsetSize);
    }

    estimateCrackTime(password) {
        const entropy = this.calculateEntropy(password);
        const attempts = Math.pow(2, entropy) / 2; // Average case
        const attemptsPerSecond = 1000000000; // 1 billion attempts per second
        
        const seconds = attempts / attemptsPerSecond;
        
        if (seconds < 60) return `${Math.round(seconds)}s`;
        if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
        if (seconds < 86400) return `${Math.round(seconds / 3600)}h`;
        if (seconds < 31536000) return `${Math.round(seconds / 86400)}d`;
        return `${Math.round(seconds / 31536000)}y`;
    }

    updateStrengthIndicator(strength) {
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        
        let color, text;
        
        if (strength < 30) {
            color = '#ef4444';
            text = 'Weak';
        } else if (strength < 60) {
            color = '#f97316';
            text = 'Fair';
        } else if (strength < 80) {
            color = '#fbbf24';
            text = 'Good';
        } else {
            color = '#22c55e';
            text = 'Strong';
        }
        
        strengthBar.style.width = `${strength}%`;
        strengthBar.style.backgroundColor = color;
        strengthText.textContent = text;
        strengthText.style.color = color;
    }

    updateSecurityChecklist(password) {
        const checklist = [
            { test: password.length >= 8, text: 'At least 8 characters' },
            { test: /[a-z]/.test(password), text: 'Contains lowercase letters' },
            { test: /[A-Z]/.test(password), text: 'Contains uppercase letters' },
            { test: /[0-9]/.test(password), text: 'Contains numbers' },
            { test: /[^A-Za-z0-9]/.test(password), text: 'Contains special characters' },
            { test: !/(.)\1{2,}/.test(password), text: 'No repeated characters' },
            { test: !/123|abc|qwe|password|admin/i.test(password), text: 'No common patterns' }
        ];
        
        const container = document.getElementById('securityChecklist');
        container.innerHTML = checklist.map(item => `
            <div class="flex items-center space-x-2">
                <i class="fas fa-${item.test ? 'check text-green-400' : 'times text-red-400'}"></i>
                <span class="text-sm ${item.test ? 'text-gray-300' : 'text-gray-500'}">${item.text}</span>
            </div>
        `).join('');
    }

    updateRecommendations(password) {
        const recommendations = [];
        
        if (password.length < 12) {
            recommendations.push('Increase length to at least 12 characters');
        }
        
        if (!/[a-z]/.test(password)) {
            recommendations.push('Add lowercase letters');
        }
        
        if (!/[A-Z]/.test(password)) {
            recommendations.push('Add uppercase letters');
        }
        
        if (!/[0-9]/.test(password)) {
            recommendations.push('Add numbers');
        }
        
        if (!/[^A-Za-z0-9]/.test(password)) {
            recommendations.push('Add special characters');
        }
        
        if (/(.)\1{2,}/.test(password)) {
            recommendations.push('Avoid repeated characters');
        }
        
        const container = document.getElementById('recommendationsList');
        
        if (recommendations.length === 0) {
            container.innerHTML = '<span class="text-green-400">✓ Password meets security requirements</span>';
        } else {
            container.innerHTML = recommendations.map(rec => `
                <div class="text-yellow-400">• ${rec}</div>
            `).join('');
        }
    }

    applyPreset(preset) {
        const presets = {
            simple: { length: 8, upper: true, lower: true, numbers: true, symbols: false },
            strong: { length: 16, upper: true, lower: true, numbers: true, symbols: true },
            ultra: { length: 32, upper: true, lower: true, numbers: true, symbols: true },
            pin: { length: 6, upper: false, lower: false, numbers: true, symbols: false }
        };
        
        const config = presets[preset];
        if (!config) return;
        
        document.getElementById('passwordLength').value = config.length;
        document.getElementById('lengthValue').textContent = config.length;
        document.getElementById('includeUppercase').checked = config.upper;
        document.getElementById('includeLowercase').checked = config.lower;
        document.getElementById('includeNumbers').checked = config.numbers;
        document.getElementById('includeSymbols').checked = config.symbols;
        
        this.generatePassword();
    }

    copyPassword() {
        const password = document.getElementById('generatedPassword').value;
        if (!password) {
            ToolAPI.showError('No password to copy');
            return;
        }
        
        navigator.clipboard.writeText(password).then(() => {
            ToolAPI.showSuccess('Password copied to clipboard');
        }).catch(() => {
            ToolAPI.showError('Could not copy password');
        });
    }

    togglePasswordVisibility() {
        const input = document.getElementById('passwordToAnalyze');
        const icon = document.getElementById('eyeIcon');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }

    addToHistory(password) {
        const historyItem = {
            password: password,
            strength: this.calculatePasswordStrength(password),
            timestamp: new Date().toLocaleString(),
            length: password.length
        };
        
        this.history.unshift(historyItem);
        this.history = this.history.slice(0, 10); // Keep only last 10
        
        localStorage.setItem('disktools-password-history', JSON.stringify(this.history));
        this.updateHistory();
    }

    updateHistory() {
        const container = document.getElementById('passwordHistory');
        
        if (this.history.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No passwords generated yet</p>';
            return;
        }
        
        container.innerHTML = this.history.map((item, index) => `
            <div class="flex items-center justify-between p-2 bg-dark/30 rounded text-sm">
                <div class="flex-1 mr-2">
                    <div class="font-mono text-xs text-gray-300 truncate">${item.password.substring(0, 20)}${item.password.length > 20 ? '...' : ''}</div>
                    <div class="text-xs text-gray-500">${item.timestamp}</div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs ${item.strength > 70 ? 'text-green-400' : item.strength > 40 ? 'text-yellow-400' : 'text-red-400'}">
                        ${item.strength > 70 ? 'Strong' : item.strength > 40 ? 'Fair' : 'Weak'}
                    </span>
                    <button onclick="copyHistoryPassword(${index})" class="text-primary hover:text-primary/80">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    clearHistory() {
        if (confirm('Are you sure you want to clear password history?')) {
            this.history = [];
            localStorage.removeItem('disktools-password-history');
            this.updateHistory();
            ToolAPI.showSuccess('Password history cleared');
        }
    }

    exportPasswords() {
        if (this.history.length === 0) {
            ToolAPI.showError('No passwords to export');
            return;
        }
        
        const csvContent = [
            ['Password', 'Strength', 'Length', 'Generated'].join(','),
            ...this.history.map(item => [
                item.password,
                item.strength,
                item.length,
                item.timestamp
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'passwords.csv';
        a.click();
        URL.revokeObjectURL(url);
        
        ToolAPI.showSuccess('Passwords exported successfully');
    }

    printPasswords() {
        if (this.history.length === 0) {
            ToolAPI.showError('No passwords to print');
            return;
        }
        
        const printContent = `
            <h1>Password History</h1>
            <table border="1" style="border-collapse: collapse; width: 100%;">
                <tr>
                    <th>Password</th>
                    <th>Strength</th>
                    <th>Length</th>
                    <th>Generated</th>
                </tr>
                ${this.history.map(item => `
                    <tr>
                        <td style="font-family: monospace;">${item.password}</td>
                        <td>${item.strength}</td>
                        <td>${item.length}</td>
                        <td>${item.timestamp}</td>
                    </tr>
                `).join('')}
            </table>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    }
}

// Global function for history copy
function copyHistoryPassword(index) {
    if (window.passwordManager && window.passwordManager.history[index]) {
        const password = window.passwordManager.history[index].password;
        navigator.clipboard.writeText(password).then(() => {
            ToolAPI.showSuccess('Password copied to clipboard');
        });
    }
}

// Initialize password manager
document.addEventListener('DOMContentLoaded', () => {
    window.passwordManager = new PasswordManager();
});
</script>
{% endblock %}
